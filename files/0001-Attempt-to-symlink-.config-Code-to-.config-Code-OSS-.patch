From 9f59b9ec37a8318e422fb9af0c83a237f1c6a2cc Mon Sep 17 00:00:00 2001
From: Joshua Strobl <joshua@streambits.io>
Date: Fri, 2 Apr 2021 09:14:32 +0300
Subject: [PATCH 1/1] Attempt to symlink .config/Code to .config/Code - OSS if
 Code does not exist.

This ensures some extensions that specifically check for Code will function. Additionally don't bother doing the platform checks. We're on Linux.
---
 .../platform/environment/node/userDataPath.js | 60 +++++--------------
 1 file changed, 16 insertions(+), 44 deletions(-)

diff --git a/src/vs/platform/environment/node/userDataPath.js b/src/vs/platform/environment/node/userDataPath.js
index 450e42aef2d..7a77dc9b804 100644
--- a/src/vs/platform/environment/node/userDataPath.js
+++ b/src/vs/platform/environment/node/userDataPath.js
@@ -10,11 +10,12 @@
 	'use strict';
 
 	/**
+	 * @param {typeof import('fs')} fs
 	 * @param {typeof import('path')} path
 	 * @param {typeof import('os')} os
 	 * @param {string} productName
 	 */
-	function factory(path, os, productName) {
+	function factory(fs, path, os, productName) {
 
 		/**
 		 * @param {import('../../environment/common/argv').NativeParsedArgs} cliArgs
@@ -31,48 +32,18 @@
 		 * @returns {string}
 		 */
 		function doGetUserDataPath(cliArgs) {
-
-			// 1. Support portable mode
-			const portablePath = process.env['VSCODE_PORTABLE'];
-			if (portablePath) {
-				return path.join(portablePath, 'user-data');
-			}
-
-			// 2. Support explicit --user-data-dir
-			const cliPath = cliArgs['user-data-dir'];
-			if (cliPath) {
-				return cliPath;
-			}
-
-			// 3. Support global VSCODE_APPDATA environment variable
-			let appDataPath = process.env['VSCODE_APPDATA'];
-
-			// 4. Otherwise check per platform
-			if (!appDataPath) {
-				switch (process.platform) {
-					case 'win32':
-						appDataPath = process.env['APPDATA'];
-						if (!appDataPath) {
-							const userProfile = process.env['USERPROFILE'];
-							if (typeof userProfile !== 'string') {
-								throw new Error('Windows: Unexpected undefined %USERPROFILE% environment variable');
-							}
-
-							appDataPath = path.join(userProfile, 'AppData', 'Roaming');
-						}
-						break;
-					case 'darwin':
-						appDataPath = path.join(os.homedir(), 'Library', 'Application Support');
-						break;
-					case 'linux':
-						appDataPath = process.env['XDG_CONFIG_HOME'] || path.join(os.homedir(), '.config');
-						break;
-					default:
-						throw new Error('Platform not supported');
-				}
+			let appDataPath = process.env['VSCODE_APPDATA'] || process.env['XDG_CONFIG_HOME'] || path.join(os.homedir(), '.config');
+			let codePath = path.join(appDataPath, productName);
+			if (productName == "Code - OSS") { // OSS equivelant
+				let nonOSSPath = path.join(appDataPath, "Code");
+				fs.access(nonOSSPath, fs.constants.F_OK, (error) => { // Access the path
+					if (error) { // File doesn't exist
+						fs.symlinkSync(codePath, nonOSSPath); // Symlink Code - OSS to Code
+					}
+				});
 			}
 
-			return path.join(appDataPath, productName);
+			return codePath;
 		}
 
 		return {
@@ -81,18 +52,19 @@
 	}
 
 	if (typeof define === 'function') {
-		define(['require', 'path', 'os', 'vs/base/common/network', 'vs/base/common/resources'], function (require, /** @type {typeof import('path')} */ path, /** @type {typeof import('os')} */ os, /** @type {typeof import('../../../base/common/network')} */ network, /** @type {typeof import("../../../base/common/resources")} */ resources) {
+		define(['require', 'fs', 'path', 'os', 'vs/base/common/network', 'vs/base/common/resources'], function (require, /** @type {typeof import('fs')} */ fs, /** @type {typeof import('path')} */ path, /** @type {typeof import('os')} */ os, /** @type {typeof import('../../../base/common/network')} */ network, /** @type {typeof import("../../../base/common/resources")} */ resources) {
 			const rootPath = resources.dirname(network.FileAccess.asFileUri('', require));
 			const pkg = require.__$__nodeRequire(resources.joinPath(rootPath, 'package.json').fsPath);
 
-			return factory(path, os, pkg.name);
+			return factory(fs, path, os, pkg.name);
 		}); // amd
 	} else if (typeof module === 'object' && typeof module.exports === 'object') {
 		const pkg = require('../../../../../package.json');
+		const fs = require('fs');
 		const path = require('path');
 		const os = require('os');
 
-		module.exports = factory(path, os, pkg.name); // commonjs
+		module.exports = factory(fs, path, os, pkg.name); // commonjs
 	} else {
 		throw new Error('Unknown context');
 	}
-- 
2.30.2

