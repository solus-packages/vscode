From d3855b1c7a5b0d10db83c01588cde6003e5539f6 Mon Sep 17 00:00:00 2001
From: Joshua Strobl <joshua@streambits.io>
Date: Fri, 5 Mar 2021 17:18:45 +0200
Subject: [PATCH 1/1] Attempt to symlink .config/Code to .config/Code - OSS if
 Code does not exist.

This ensures some extensions that specifically check for Code will function. Additionally don't bother doing the platform checks. We're on Linux.
---
 src/vs/base/node/userDataPath.js | 47 +++++++++++---------------------
 1 file changed, 16 insertions(+), 31 deletions(-)

diff --git a/src/vs/base/node/userDataPath.js b/src/vs/base/node/userDataPath.js
index 93384cb8f4e..26d6e70e5f1 100644
--- a/src/vs/base/node/userDataPath.js
+++ b/src/vs/base/node/userDataPath.js
@@ -10,42 +10,26 @@
 	'use strict';
 
 	/**
+	 * @param {typeof import('fs') fs
 	 * @param {typeof import('path')} path
 	 * @param {typeof import('os')} os
 	 * @param {string} productName
 	 */
-	function factory(path, os, productName) {
+	function factory(fs, path, os, productName) {
 
 		function getDefaultUserDataPath() {
-
-			// Support global VSCODE_APPDATA environment variable
-			let appDataPath = process.env['VSCODE_APPDATA'];
-
-			// Otherwise check per platform
-			if (!appDataPath) {
-				switch (process.platform) {
-					case 'win32':
-						appDataPath = process.env['APPDATA'];
-						if (!appDataPath) {
-							const userProfile = process.env['USERPROFILE'];
-							if (typeof userProfile !== 'string') {
-								throw new Error('Windows: Unexpected undefined %USERPROFILE% environment variable');
-							}
-							appDataPath = path.join(userProfile, 'AppData', 'Roaming');
-						}
-						break;
-					case 'darwin':
-						appDataPath = path.join(os.homedir(), 'Library', 'Application Support');
-						break;
-					case 'linux':
-						appDataPath = process.env['XDG_CONFIG_HOME'] || path.join(os.homedir(), '.config');
-						break;
-					default:
-						throw new Error('Platform not supported');
-				}
+			let appDataPath = process.env['VSCODE_APPDATA'] || process.env['XDG_CONFIG_HOME'] || path.join(os.homedir(), '.config');
+			let codePath = path.join(appDataPath, productName);
+			if (productName == "Code - OSS") { // OSS equivelant
+				let nonOSSPath = path.join(appDataPath, "Code");
+				fs.access(nonOSSPath, fs.constants.F_OK, (error) => { // Access the path
+					if (error) { // File doesn't exist
+						fs.symlinkSync(codePath, nonOSSPath); // Symlink Code - OSS to Code
+					}
+				})
 			}
 
-			return path.join(appDataPath, productName);
+			return codePath;
 		}
 
 		return {
@@ -54,18 +38,19 @@
 	}
 
 	if (typeof define === 'function') {
-		define(['require', 'path', 'os', 'vs/base/common/network', 'vs/base/common/resources'], function (require, /** @type {typeof import('path')} */ path, /** @type {typeof import('os')} */ os, /** @type {typeof import('../common/network')} */ network, /** @type {typeof import("../common/resources")} */ resources) {
+		define(['require', 'fs', 'path', 'os', 'vs/base/common/network', 'vs/base/common/resources'], function (require, /** @type {typeof import('fs')} */ fs, /** @type {typeof import('path')} */ path, /** @type {typeof import('os')} */ os, /** @type {typeof import('../common/network')} */ network, /** @type {typeof import("../common/resources")} */ resources) {
 			const rootPath = resources.dirname(network.FileAccess.asFileUri('', require));
 			const pkg = require.__$__nodeRequire(resources.joinPath(rootPath, 'package.json').fsPath);
 
-			return factory(path, os, pkg.name);
+			return factory(fs, path, os, pkg.name);
 		}); // amd
 	} else if (typeof module === 'object' && typeof module.exports === 'object') {
 		const pkg = require('../../../../package.json');
+		const fs = require('fs');
 		const path = require('path');
 		const os = require('os');
 
-		module.exports = factory(path, os, pkg.name); // commonjs
+		module.exports = factory(fs, path, os, pkg.name); // commonjs
 	} else {
 		throw new Error('Unknown context');
 	}
-- 
2.30.0

